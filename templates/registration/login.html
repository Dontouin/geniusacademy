{% extends 'registration/registration_base.html' %}
{% load i18n %}
{% block title %}{% trans 'The Genius Academy - Connexion' %}{% endblock title %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid login-container">
  <div class="row justify-content-center align-items-center min-vh-100 py-3 py-md-5">
    <div class="col-11 col-sm-9 col-md-7 col-lg-5 col-xl-4">
      <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <!-- En-tête avec logo et titre -->
        <div class="card-header bg-primary text-white text-center py-3 py-md-4 position-relative">
          <div class="position-absolute top-0 start-0 p-2 p-md-3 opacity-25">
            <i class="fas fa-brain fa-1x fa-md-2x"></i>
          </div>
          <div class="position-absolute top-0 end-0 p-2 p-md-3 opacity-25">
            <i class="fas fa-book-open fa-1x fa-md-2x"></i>
          </div>
          <div class="mb-2 mb-md-3">
            <i class="fas fa-graduation-cap fa-2x fa-md-3x"></i>
          </div>
          <h3 class="mb-0 fw-bold fs-4 fs-md-3">{% trans 'The Genius Academy' %}</h3>
          <p class="mb-0 opacity-75 small mt-1">{% trans 'Répétition à domicile au Cameroun' %}</p>
        </div>
        
        <div class="card-body p-3 p-md-4">
          <!-- Formulaire de connexion -->
          <h4 class="text-center mb-3 mb-md-4 fs-5">
            <i class="fas fa-lock me-2 text-primary"></i> {% trans 'Connectez-vous à votre compte' %}
          </h4>
          
          <form action="" method="POST" id="login-form" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Champ identifiant -->
            <div class="form-group mb-3 mb-md-4">
              <label class="form-label fw-semibold" for="username_id">
                <i class="fas fa-address-card me-2 text-primary"></i>{% trans 'Numéro ID' %}
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 py-2">
                  <i class="fas fa-user text-muted"></i>
                </span>
                <input type="text" name="username" id="username_id" 
                       class="form-control border-start-0 ps-2 py-2" 
                       placeholder="{% trans 'Entrez votre numéro ID' %}" required
                       style="min-height: 44px;"> <!-- Taille tactile optimale -->
              </div>
              <div id="message-wrapper" class="mt-1 mt-md-2"></div>
            </div>

            <!-- Champ mot de passe -->
            <div class="form-group mb-3 mb-md-4">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label fw-semibold" for="password_id">
                  <i class="fas fa-key me-2 text-primary"></i>{% trans 'Mot de passe' %}
                </label>
                <a href="{% url 'password_reset' %}" class="link-primary text-decoration-none small">
                  {% trans 'Mot de passe oublié?' %}
                </a>
              </div>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0 py-2">
                  <i class="fas fa-lock text-muted"></i>
                </span>
                <input type="password" name="password" id="password_id" 
                       class="form-control border-start-0 ps-2 py-2" 
                       placeholder="{% trans 'Entrez votre mot de passe' %}" required
                       style="min-height: 44px;"> <!-- Taille tactile optimale -->
                <button class="btn btn-outline-secondary toggle-password py-2" type="button"
                        style="min-width: 44px; min-height: 44px;"> <!-- Taille tactile optimale -->
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <!-- Message d'erreur -->
            {% if form.errors %}
            <div class="alert alert-danger d-flex align-items-center mb-3 mb-md-4 py-2" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i>
              <div class="small">{% trans 'ID ou mot de passe invalide.' %}</div>
            </div>
            {% endif %}

            <!-- Bouton de connexion -->
            <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold rounded-3 shadow-sm" id="login-btn"
                    style="min-height: 44px;"> <!-- Taille tactile optimale -->
              <i class="fas fa-sign-in-alt me-2"></i> {% trans 'SE CONNECTER' %}
            </button>
          </form>

          <!-- Séparateur -->
          <div class="text-center my-3 my-md-4 position-relative">
            <hr class="my-2">
            <span class="position-absolute top-50 start-50 translate-middle bg-white px-2 text-muted small">
              {% trans 'Nouveau sur Genius Academy?' %}
            </span>
          </div>

          <!-- Lien d'inscription -->
          <div class="text-center">
            <a href="{% url 'register_choice' %}" class="btn btn-outline-primary w-100 py-2 rounded-3 shadow-sm"
               style="min-height: 44px;"> <!-- Taille tactile optimale -->
              <i class="fas fa-user-plus me-2"></i> {% trans 'Créer un compte' %}
            </a>
          </div>
        </div>
        
        <!-- Pied de carte -->
        <div class="card-footer bg-light text-center py-2 py-md-3">
          <small class="text-muted">
            &copy; {% now "Y" %} The Genius Academy. {% trans 'Tous droits réservés.' %}
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block js %}
<script>
  $(document).ready(function() {
    // Fonctionnalité pour basculer la visibilité du mot de passe
    $('.toggle-password').click(function() {
      const passwordInput = $('#password_id');
      const type = passwordInput.attr('type') === 'password' ? 'text' : 'password';
      passwordInput.attr('type', type);
      $(this).find('i').toggleClass('fa-eye fa-eye-slash');
      
      // Feedback tactile
      $(this).addClass('btn-active');
      setTimeout(() => {
        $(this).removeClass('btn-active');
      }, 200);
    });
    
    // Animation lors de la soumission du formulaire
    $('#login-form').submit(function () {
      $('#login-btn').addClass('disabled');
      $('#login-btn').html(`<div class="spinner-border spinner-border-sm me-2" role="status"></div> {% trans 'Connexion en cours...' %}`);
    });

    // Validation en temps réel de l'identifiant
    $("#username_id").on("input", function () {
      let username = $(this).val();
      if (username.length < 3) {
        $('#message-wrapper').html('');
        return;
      }
      
      $.ajax({
        url: "/accounts/ajax/validate-username/",
        data: { username: username },
        dataType: 'json',
        success: function (data) {
          if (data.is_taken) {
            $('#message-wrapper').html(`
              <div class="alert alert-warning py-1 py-md-2 mb-0 d-flex align-items-center small">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div><b>${username}</b> {% trans 'est déjà pris. Veuillez en essayer un autre.' %}</div>
              </div>
            `);
          } else {
            $('#message-wrapper').html(`
              <div class="alert alert-success py-1 py-md-2 mb-0 d-flex align-items-center small">
                <i class="fas fa-check-circle me-2"></i>
                <div><b>${username}</b> {% trans 'est disponible.' %}</div>
              </div>
            `);
          }
        },
        error: function() {
          $('#message-wrapper').html(`
            <div class="alert alert-info py-1 py-md-2 mb-0 d-flex align-items-center small">
              <i class="fas fa-info-circle me-2"></i>
              <div>{% trans 'Vérification de la disponibilité...' %}</div>
            </div>
          `);
        }
      });
    });
    
    // Validation Bootstrap
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
    
    // Amélioration de l'expérience tactile
    $('input, button, a').on('touchstart', function() {
      $(this).addClass('touch-active');
    });
    
    $('input, button, a').on('touchend', function() {
      $(this).removeClass('touch-active');
    });
  });
</script>

<style>
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    font-family: 'Poppins', sans-serif;
    -webkit-tap-highlight-color: transparent; /* Désactive le surlignage bleu au tap sur Android */
  }
  
  .min-vh-100 {
    min-height: 100vh;
  }
  
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
  }
  
  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
  }
  
  .btn-primary {
    background: linear-gradient(to right, #0d6efd, #0a58ca);
    border: none;
    transition: all 0.3s ease;
  }
  
  .btn-primary:hover, .btn-primary:active {
    background: linear-gradient(to right, #0a58ca, #084298);
    transform: translateY(-2px);
  }
  
  .btn-outline-primary:hover, .btn-outline-primary:active {
    background-color: #0d6efd;
    color: white;
  }
  
  .toggle-password {
    border-left: none;
    transition: all 0.2s ease;
  }
  
  .toggle-password:hover, .toggle-password:active {
    background-color: #f8f9fa;
    color: #0d6efd;
  }
  
  .input-group-text {
    transition: background-color 0.3s ease;
  }
  
  .input-group:focus-within .input-group-text {
    background-color: #e9ecef;
    border-color: #86b7fe;
  }
  
  .login-container {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230d6efd' fill-opacity='0.03' d='M0,128L48,117.3C96,107,192,85,288,112C384,139,480,213,576,224C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
    background-size: cover;
    background-position: center bottom;
  }
  
  /* Styles pour améliorer l'expérience mobile */
  @media (max-width: 576px) {
    .container-fluid {
      padding-left: 5px;
      padding-right: 5px;
    }
    
    .card {
      border-radius: 12px !important;
      margin: 0 5px;
    }
    
    .card-header h3 {
      font-size: 1.2rem !important;
    }
    
    .form-label {
      font-size: 0.9rem;
    }
    
    .btn {
      font-size: 0.9rem;
    }
  }
  
  /* Améliorations pour les appareils tactiles */
  .touch-active, .btn-active {
    transform: scale(0.98) !important;
    opacity: 0.9;
  }
  
  input, button, a {
    -webkit-tap-highlight-color: transparent;
  }
  
  /* Correction du zoom sur iOS */
  @media screen and (max-width: 768px) {
    input, select, textarea {
      font-size: 16px !important; /* Empêche le zoom automatique sur iOS */
    }
  }
  
  /* Ajustements pour les très petits écrans */
  @media (max-width: 360px) {
    .card-header {
      padding: 1.5rem 0.5rem !important;
    }
    
    .card-body {
      padding: 1rem !important;
    }
    
    .btn {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
  }
  
  /* Amélioration de la visibilité des éléments interactifs */
  @media (pointer: coarse) {
    .btn, .form-control, .input-group-text {
      min-height: 44px; /* Taille minimale recommandée pour les éléments tactiles */
    }
    
    .toggle-password {
      min-width: 44px;
    }
  }
</style>
{% endblock %}