{% load static %}
{% load i18n %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5 text-center">
        <div class="col-12">
            <h1 class="display-4 fw-bold text-primary mb-3" data-aos="fade-down">{% trans "Témoignages" %}</h1>
            <p class="lead text-muted mb-4" data-aos="fade-down" data-aos-delay="100">{% trans "Découvrez ce que nos élèves, parents et enseignants disent de leur expérience avec" %} {{ site_name }}</p>
            
            <!-- Rating Summary -->
            <div class="d-flex justify-content-center align-items-center mt-4" data-aos="fade-up" data-aos-delay="200">
                <div class="rating-summary d-flex align-items-center p-3">
                    <div class="me-3 text-center">
                        <h2 class="fw-bold text-white mb-0">{{ average_rating }}</h2>
                        <div class="text-warning mb-1">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= average_rating|floatformat:0|add:"0" %}
                                    <i class="fas fa-star"></i>
                                {% elif forloop.counter|add:"-0.5" <= average_rating %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <small class="text-white opacity-90">{% trans "Basé sur" %} {{ total_testimonials }} {% trans "avis" %}</small>
                    </div>
                    <div class="vr mx-3 d-none d-md-block opacity-25 bg-white"></div>
                    <div class="mt-2 mt-md-0">
                        <a href="#testimonial-form" class="btn btn-light rounded-pill px-4 smooth-scroll">
                            <i class="fas fa-pen me-2"></i>{% trans "Laisser un témoignage" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Testimonials Carousel -->
    {% if featured_testimonials %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="glass-card mb-5" data-aos="fade-up">
                <div class="card-header bg-transparent border-0 py-4">
                    <h3 class="card-title mb-0 text-center">
                        <i class="fas fa-star text-warning me-2"></i>
                        {% trans "Témoignages à la une" %}
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div id="testimonialsCarousel" class="carousel slide" data-bs-ride="carousel">
                        <!-- Indicators -->
                        <div class="carousel-indicators">
                            {% for testimonial in featured_testimonials %}
                                <button type="button" data-bs-target="#testimonialsCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
                            {% endfor %}
                        </div>
                        
                        <!-- Carousel items -->
                        <div class="carousel-inner">
                            {% for testimonial in featured_testimonials %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}" data-bs-interval="6000">
                                    <div class="testimonial-carousel-content text-center px-4 px-md-5">
                                        <div class="d-flex justify-content-center mb-4">
                                            <div class="avatar-wrapper">
                                                {% if testimonial.image %}
                                                    <img src="{{ testimonial.image.url }}" alt="{{ testimonial.author }}" class="avatar" loading="lazy">
                                                {% else %}
                                                    <div class="avatar-placeholder">{{ testimonial.author_initials }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="testimonial-stars justify-content-center mb-3">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= testimonial.rating %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                        <blockquote class="blockquote mb-4 mx-auto" style="max-width: 800px;">
                                            <p class="font-italic fs-5 testimonial-text">"{{ testimonial.excerpt }}"</p>
                                        </blockquote>
                                        
                                        <div class="testimonial-author justify-content-center">
                                            <h5 class="mb-1 text-primary">{{ testimonial.author }}</h5>
                                            <p class="text-muted mb-0">{{ testimonial.get_type_display }}</p>
                                            <span class="badge bg-warning text-dark mt-2">
                                                <i class="fas fa-star me-1"></i>{% trans "En vedette" %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Controls -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#testimonialsCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">{% trans "Précédent" %}</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#testimonialsCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">{% trans "Suivant" %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Testimonials Grid -->
    <div class="row mb-5" id="testimonials-grid">
        <div class="col-12 mb-4">
            <h3 class="text-center mb-4 section-title" data-aos="fade-up">{% trans "Tous les témoignages" %}</h3>
        </div>
        
        <!-- Testimonials will be loaded here dynamically -->
        <div id="testimonials-container" class="row">
            {% for testimonial in testimonials %}
                <div class="col-md-6 col-lg-4 mb-4 testimonial-item" 
                     data-aos="fade-up" 
                     data-aos-delay="{{ forloop.counter|add:"-1"|divisibleby:3|yesno:"100,150" }}"
                     data-type="{{ testimonial.testimonial_type }}"
                     data-rating="{{ testimonial.rating }}"
                     data-date="{{ testimonial.created_at|date:'Y-m-d' }}">
                    <div class="testimonial-card glass-card h-100">
                        {% if testimonial.featured %}
                            <span class="featured-badge">
                                <i class="fas fa-star me-1"></i>{% trans "En vedette" %}
                            </span>
                        {% endif %}
                        
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-wrapper">
                                    {% if testimonial.image %}
                                        <img src="{{ testimonial.image.url }}" alt="{{ testimonial.author }}" class="avatar avatar-small" loading="lazy">
                                    {% else %}
                                        <div class="avatar-placeholder avatar-small">{{ testimonial.author_initials }}</div>
                                    {% endif %}
                                </div>
                                <div class="ms-3">
                                    <h6 class="mb-0 author-name">{{ testimonial.author }}</h6>
                                    <small class="author-type">{{ testimonial.get_type_display }}</small>
                                </div>
                            </div>
                            
                            <div class="testimonial-stars mb-3">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= testimonial.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <p class="testimonial-excerpt">"{{ testimonial.excerpt }}"</p>
                        </div>
                        
                        <div class="card-footer bg-transparent border-0 pt-0 d-flex justify-content-between align-items-center">
                            <small class="testimonial-date">
                                <i class="far fa-clock me-1"></i>{{ testimonial.created_at|timesince }}
                            </small>
                            <button class="btn btn-sm read-more-btn" data-testimonial-id="{{ testimonial.id }}">
                                {% trans "Lire plus" %}
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination -->
    {% if testimonials.has_other_pages %}
    <div class="row mb-5">
        <div class="col-12">
            <nav aria-label="Testimonials pagination">
                <ul class="pagination justify-content-center">
                    {% if testimonials.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ testimonials.previous_page_number }}">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;</span>
                        </li>
                    {% endif %}
                    
                    {% for i in testimonials.paginator.page_range %}
                        {% if testimonials.number == i %}
                            <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if testimonials.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ testimonials.next_page_number }}">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}

    <!-- Testimonial Form Section -->
    <div class="row justify-content-center mb-5" id="testimonial-form">
        <div class="col-lg-8">
            <div class="glass-card" data-aos="fade-up">
                <div class="card-header bg-primary text-white py-4">
                    <h3 class="mb-0 text-center"><i class="fas fa-pen me-2"></i>{% trans "Partagez votre expérience" %}</h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="testimonialForm">
                        {% csrf_token %}
                        
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        <div class="row">
                            <!-- Author Name -->
                            <div class="col-md-6 mb-3">
                                <label for="author" class="form-label">{% trans "Votre nom" %}</label>
                                <input type="text" class="form-control" id="author" name="author" required value="{{ form.author.value|default:'' }}">
                                {% if form.author.errors %}
                                    <div class="text-danger">{{ form.author.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Testimonial Type -->
                            <div class="col-md-6 mb-3">
                                <label for="testimonial_type" class="form-label">{% trans "Vous êtes" %}</label>
                                <select class="form-select" id="testimonial_type" name="testimonial_type" required>
                                    <option value="">{% trans "Sélectionnez..." %}</option>
                                    <option value="student" {% if form.testimonial_type.value == 'student' %}selected{% endif %}>{% trans "Élève/Étudiant" %}</option>
                                    <option value="parent" {% if form.testimonial_type.value == 'parent' %}selected{% endif %}>{% trans "Parent" %}</option>
                                    <option value="teacher" {% if form.testimonial_type.value == 'teacher' %}selected{% endif %}>{% trans "Enseignant" %}</option>
                                </select>
                                {% if form.testimonial_type.errors %}
                                    <div class="text-danger">{{ form.testimonial_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Rating Section -->
                        <div class="mb-4">
                            <label class="form-label">{% trans "Donnez une note" %}</label>
                            <div class="d-flex align-items-center">
                                <div class="star-rating me-3">
                                    {% for i in "12345"|make_list %}
                                        <input type="radio" id="star{{ forloop.revcounter }}" name="rating" value="{{ forloop.revcounter }}" {% if form.rating.value == forloop.revcounter|stringformat:'i' %}checked{% endif %}>
                                        <label for="star{{ forloop.revcounter }}"><i class="fas fa-star"></i></label>
                                    {% endfor %}
                                </div>
                                <span id="rating-text">{% trans "Sélectionnez une note" %}</span>
                            </div>
                            {% if form.rating.errors %}
                                <div class="text-danger">{{ form.rating.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Content -->
                        <div class="mb-4">
                            <label for="content" class="form-label">{% trans "Votre témoignage" %}</label>
                            <textarea class="form-control" id="content" name="content" rows="5" required>{{ form.content.value|default:'' }}</textarea>
                            <div class="form-text">{% trans "Votre témoignage doit contenir au moins 20 caractères." %}</div>
                            {% if form.content.errors %}
                                <div class="text-danger">{{ form.content.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Image -->
                        <div class="mb-4">
                            <label for="image" class="form-label">{% trans "Photo de profil (optionnel)" %}</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/jpeg,image/png">
                            <div class="form-text">{% trans "Formats acceptés: JPG, PNG. Taille maximale: 5MB." %}</div>
                            {% if form.image.errors %}
                                <div class="text-danger">{{ form.image.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>{% trans "Soumettre mon témoignage" %}
                            </button>
                        </div>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                {% trans "Votre témoignage sera examiné par notre équipe avant publication." %}
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles pour la section témoignages */
.glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    overflow: hidden;
}

.glass-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.rating-summary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border-radius: 50px;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.avatar-wrapper {
    position: relative;
    display: inline-block;
}

.avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.avatar-small {
    width: 50px;
    height: 50px;
}

.avatar-placeholder {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    font-weight: bold;
    font-size: 2rem;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.avatar-small.avatar-placeholder {
    font-size: 1.2rem;
}

.testimonial-card {
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
}

.testimonial-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.testimonial-stars {
    display: flex;
    gap: 0.15rem;
    margin-bottom: 1rem;
}

.testimonial-stars i {
    color: #f59e0b;
    font-size: 0.95rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.testimonial-excerpt {
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    color: #4b5563;
    font-style: italic;
    margin-bottom: 1.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.read-more-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 0.5rem 1.25rem;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(99, 102, 241, 0.2);
}

.read-more-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3);
    color: white;
}

.testimonial-date {
    color: #9ca3af;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
}

.testimonial-date i {
    margin-right: 0.5rem;
}

.author-name {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
    font-size: 1.05rem;
}

.author-type {
    color: #6b7280;
    font-size: 0.9rem;
    margin-bottom: 0;
}

.featured-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #7c2d12;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(255, 215, 0, 0.3);
    z-index: 10;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.section-title {
    position: relative;
    display: inline-block;
    margin-bottom: 2rem;
}

.section-title::after {
    content: "";
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 4px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 2px;
}

/* Star rating system */
.star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.star-rating input {
    display: none;
}

.star-rating label {
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.star-rating label i {
    color: #e2e8f0;
    font-size: 1.5rem;
    transition: all 0.2s ease;
}

.star-rating input:checked ~ label i,
.star-rating label:hover i,
.star-rating label:hover ~ label i {
    color: #f59e0b;
}

.star-rating input:checked ~ label i {
    text-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .avatar, .avatar-placeholder {
        width: 80px;
        height: 80px;
    }
    
    .avatar-small, .avatar-small.avatar-placeholder {
        width: 40px;
        height: 40px;
    }
    
    .rating-summary {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .rating-summary .vr {
        display: none;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Star rating interaction
    const starInputs = document.querySelectorAll('.star-rating input');
    const ratingText = document.getElementById('rating-text');
    
    const ratingLabels = {
        1: "{% trans 'Décevant' %}",
        2: "{% trans 'Moyen' %}",
        3: "{% trans 'Bien' %}",
        4: "{% trans 'Très bien' %}",
        5: "{% trans 'Excellent' %}"
    };
    
    starInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (ratingText) {
                ratingText.textContent = ratingLabels[this.value];
            }
        });
    });
    
    // Initialize rating text if a rating is already selected
    const selectedRating = document.querySelector('.star-rating input:checked');
    if (selectedRating && ratingText) {
        ratingText.textContent = ratingLabels[selectedRating.value];
    }
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('.smooth-scroll').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
{% endblock %}